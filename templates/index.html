<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæ•°æ®å¯¼å‡ºå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #333;
        }
        
        .container {
            width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .tab.active {
            color: #667eea;
            background: white;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fff;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: #ced4da;
        }
        
        .form-group textarea {
            height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .alert {
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .column-mapping {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            background: #f8f9fa;
        }
        
        .column-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .column-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .column-item span {
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
        }
        
        .template-list {
            margin-bottom: 20px;
        }
        
        .template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }
        
        .template-item span {
            font-weight: 500;
            color: #495057;
        }
        
        .template-item div {
            display: flex;
            gap: 5px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .api-url-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            margin-bottom: 25px;
        }
        
        .url-input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .url-input-group input {
            flex: 1;
        }
        
        .parse-btn {
            white-space: nowrap;
            font-size: 12px;
            padding: 8px 15px;
            margin: 0;
        }
        
        .method-group {
            margin-top: 15px;
            max-width: 200px;
        }
        
        .pagination-config {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-top: 15px;
        }
        
        .pagination-config h4 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 16px;
        }
        
        #apiResult {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        #apiResult h3 {
            margin-bottom: 15px;
            color: #495057;
        }
        
        #apiResult pre {
            background: #ffffff;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.4;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            #config > div {
                flex-direction: column !important;
                gap: 20px !important;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .column-item {
                flex-direction: column;
                align-items: stretch;
            }
            
            .column-item span {
                text-align: center;
                margin: 5px 0;
            }
            
            .template-item {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .template-item div {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ APIæ•°æ®å¯¼å‡ºå·¥å…·</h1>
            <p>ç®€å•æ˜“ç”¨çš„APIæ•°æ®è·å–ä¸Excelå¯¼å‡ºè§£å†³æ–¹æ¡ˆ</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('config')">é…ç½®ä¸å¯¼å‡º</button>
            <button class="tab" onclick="showTab('template')">æ¨¡æ¿ç®¡ç†</button>
        </div>
        
        <!-- é…ç½®ä¸å¯¼å‡º -->
        <div id="config" class="tab-content active">
            <div style="display: flex; gap: 30px;">
                <!-- å·¦ä¾§ï¼šAPIé…ç½® -->
                <div style="flex: 1;">
                    <h2 style="margin-bottom: 25px; color: #495057;">ğŸ”§ APIæ¥å£é…ç½®</h2>
                    <form id="apiForm">
                        <div class="api-url-section">
                            <div class="form-group">
                                <label for="apiUrl">æ¥å£åœ°å€</label>
                                <div class="url-input-group">
                                    <input type="url" id="apiUrl" placeholder="https://api.example.com/data" required>
                                    <button type="button" class="btn btn-secondary parse-btn" onclick="parseUrlParams()">è§£æURLå‚æ•°</button>
                                </div>
                            </div>
                            <div class="form-group method-group">
                                <label for="apiMethod">è¯·æ±‚æ–¹æ³•</label>
                                <select id="apiMethod">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="apiHeaders">è¯·æ±‚å¤´ (JSONæ ¼å¼)</label>
                            <textarea id="apiHeaders" placeholder='{"Authorization": "Bearer your-token", "Content-Type": "application/json"}'></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="apiParams">è¯·æ±‚å‚æ•° (JSONæ ¼å¼)</label>
                            <textarea id="apiParams" placeholder='{"page": 1, "size": 100}'></textarea>
                            <small>å‚æ•°ä¿®æ”¹ä¼šè‡ªåŠ¨åŒæ­¥åˆ°URLä¸­</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="apiData">è¯·æ±‚ä½“æ•°æ® (JSONæ ¼å¼ï¼Œä»…POST)</label>
                            <textarea id="apiData" placeholder='{"query": "example"}'></textarea>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="testApi()">ğŸ§ª æµ‹è¯•æ¥å£</button>
                    </form>
                    
                    <div id="apiResult" style="margin-top: 20px;"></div>
                </div>
                
                <!-- å³ä¾§ï¼šExcelé…ç½® -->
                <div style="flex: 1;">
                    <h2 style="margin-bottom: 25px; color: #495057;">ğŸ“Š Excelå¯¼å‡ºé…ç½®</h2>
                    <form id="excelForm">
                        <div class="form-group">
                            <label for="dataPath">æ•°æ®è·¯å¾„</label>
                            <input type="text" id="dataPath" placeholder="data.items (ç”¨.åˆ†éš”åµŒå¥—å­—æ®µ)">
                            <small>å¦‚æœAPIè¿”å›çš„æ•°æ®åœ¨åµŒå¥—å¯¹è±¡ä¸­ï¼Œè¯·æŒ‡å®šè·¯å¾„ï¼Œå¦‚ï¼šdata.items</small>
                        </div>
                        
                        <div class="form-group">
                            <label>åˆ—æ˜ å°„é…ç½®</label>
                            <div class="column-mapping">
                                <div id="columnMappings">
                                    <div class="column-item">
                                        <input type="text" placeholder="APIå­—æ®µå" class="api-field">
                                        <span>â†’</span>
                                        <input type="text" placeholder="Excelåˆ—å" class="excel-field">
                                        <button type="button" class="btn btn-danger" onclick="removeColumnMapping(this)">åˆ é™¤</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secondary" onclick="addColumnMapping()">æ·»åŠ åˆ—æ˜ å°„</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="selectedColumns">é€‰æ‹©å¯¼å‡ºåˆ— (é€—å·åˆ†éš”)</label>
                            <input type="text" id="selectedColumns" placeholder="id,name,email,created_at">
                            <small>ç•™ç©ºåˆ™å¯¼å‡ºæ‰€æœ‰åˆ—</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="exportMode">å¯¼å‡ºæ¨¡å¼</label>
                            <select id="exportMode" onchange="togglePaginationConfig()">
                                <option value="current">å½“å‰é¡µæ•°æ®</option>
                                <option value="all">å…¨éƒ¨æ•°æ®ï¼ˆè‡ªåŠ¨åˆ†é¡µï¼‰</option>
                            </select>
                            <small>é€‰æ‹©"å…¨éƒ¨æ•°æ®"å°†è‡ªåŠ¨è·å–æ‰€æœ‰åˆ†é¡µæ•°æ®</small>
                        </div>
                        
                        <div class="form-group" id="paginationConfig" style="display: none;">
                            <label>åˆ†é¡µé…ç½®</label>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1; margin-right: 10px;">
                                    <label for="cursorParam">æ¸¸æ ‡å‚æ•°å</label>
                                    <input type="text" id="cursorParam" value="cursor" placeholder="å¦‚ï¼šcursor">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label for="pageSizeParam">é¡µå¤§å°å‚æ•°å</label>
                                    <input type="text" id="pageSizeParam" value="per_page" placeholder="å¦‚ï¼šper_page">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1; margin-right: 10px;">
                                    <label for="pageParam">é¡µç å‚æ•°å</label>
                                    <input type="text" id="pageParam" value="page" placeholder="å¦‚ï¼špageï¼ˆç”¨äºæ— æ¸¸æ ‡åˆ†é¡µï¼‰">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label for="maxPages">æœ€å¤§é¡µæ•°é™åˆ¶</label>
                                    <input type="number" id="maxPages" value="100" min="1" max="1000" placeholder="é˜²æ­¢æ— é™å¾ªç¯">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label for="nextCursorPath">ä¸‹ä¸€é¡µæ¸¸æ ‡è·¯å¾„</label>
                                    <input type="text" id="nextCursorPath" value="links.next.cursor" placeholder="å¦‚ï¼šlinks.next.cursor">
                                </div>
                            </div>
                            <small>æ”¯æŒæ¸¸æ ‡åˆ†é¡µï¼ˆå¦‚Sentry APIï¼‰å’Œé¡µç åˆ†é¡µä¸¤ç§æ¨¡å¼ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ¤æ–­ä½¿ç”¨å“ªç§æ–¹å¼</small>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center;">
                <div class="form-group" style="display: inline-block; margin-right: 20px;">
                    <label for="templateName">æ¨¡æ¿åç§°</label>
                    <input type="text" id="templateName" placeholder="è¾“å…¥æ¨¡æ¿åç§°" style="width: 200px; display: inline-block;">
                </div>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">ğŸ’¾ ä¿å­˜ä¸ºæ¨¡æ¿</button>
                <button type="button" class="btn btn-success" onclick="exportData()">ğŸ“¥ å¯¼å‡ºExcel</button>
                <button type="button" class="btn btn-secondary" onclick="clearAllForms()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
            </div>
        </div>
        
        <!-- æ¨¡æ¿ç®¡ç† -->
        <div id="template" class="tab-content">
            <h2 style="margin-bottom: 25px; color: #495057;">ğŸ’¾ æ¨¡æ¿ç®¡ç†</h2>
            
            <div class="template-list">
                <h3 style="color: #495057; margin-bottom: 15px;">ğŸ“‹ å·²ä¿å­˜çš„æ¨¡æ¿</h3>
                <div id="templateItems"></div>
            </div>
            
            <button type="button" class="btn btn-secondary" onclick="loadTemplates()">ğŸ”„ åˆ·æ–°æ¨¡æ¿åˆ—è¡¨</button>
        </div>
        
        <!-- åŠ è½½åŠ¨ç”» -->
        <div id="loading" class="loading"></div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentConfig = {
            api_config: {},
            excel_config: {}
        };
        
        // URLå‚æ•°è§£æå’ŒåŒæ­¥
         function parseUrlParams() {
             const urlInput = document.getElementById('apiUrl');
             const paramsTextarea = document.getElementById('apiParams');
             
             try {
                 const url = new URL(urlInput.value);
                 const params = {};
                 
                 // æå–URLä¸­çš„æŸ¥è¯¢å‚æ•°ï¼Œæ­£ç¡®å¤„ç†URLç¼–ç 
                 url.searchParams.forEach((value, key) => {
                     // å¯¹äºæ•°ç»„å‚æ•°ï¼ˆå¦‚fieldï¼‰ï¼Œä¿æŒåŸå§‹æ ¼å¼
                     if (params[key]) {
                         // å¦‚æœå‚æ•°å·²å­˜åœ¨ï¼Œè½¬æ¢ä¸ºæ•°ç»„
                         if (Array.isArray(params[key])) {
                             params[key].push(value);
                         } else {
                             params[key] = [params[key], value];
                         }
                     } else {
                         params[key] = value;
                     }
                 });
                 
                 // åˆå¹¶ç°æœ‰å‚æ•°å’ŒURLå‚æ•°
                 let existingParams = {};
                 try {
                     existingParams = JSON.parse(paramsTextarea.value || '{}');
                 } catch (e) {
                     // å¦‚æœç°æœ‰å‚æ•°æ ¼å¼é”™è¯¯ï¼Œä½¿ç”¨ç©ºå¯¹è±¡
                 }
                 
                 const mergedParams = { ...existingParams, ...params };
                 
                 // æ›´æ–°å‚æ•°æ–‡æœ¬æ¡†
                 paramsTextarea.value = JSON.stringify(mergedParams, null, 2);
                 
                 // æ¸…ç†URLä¸­çš„æŸ¥è¯¢å‚æ•°ï¼Œä¿ç•™åŸºç¡€URL
                 const cleanUrl = url.origin + url.pathname;
                 urlInput.value = cleanUrl;
                 
                 if (Object.keys(params).length > 0) {
                     showMessage(`å·²è§£æ ${Object.keys(params).length} ä¸ªURLå‚æ•°`);
                 }
                 
             } catch (error) {
                 // URLæ ¼å¼é”™è¯¯æ—¶ä¸å¤„ç†
                 console.log('URLæ ¼å¼é”™è¯¯æˆ–ä¸ºç©º:', error.message);
             }
         }
        
        // å‚æ•°åŒæ­¥åˆ°URL
         function syncParamsToUrl() {
             const urlInput = document.getElementById('apiUrl');
             const paramsTextarea = document.getElementById('apiParams');
             
             try {
                 const baseUrl = urlInput.value;
                 const params = JSON.parse(paramsTextarea.value || '{}');
                 
                 if (baseUrl && Object.keys(params).length > 0) {
                     const url = new URL(baseUrl);
                     
                     // æ¸…é™¤ç°æœ‰æŸ¥è¯¢å‚æ•°
                     url.search = '';
                     
                     // æ·»åŠ æ–°å‚æ•°ï¼Œæ­£ç¡®å¤„ç†æ•°ç»„å’Œç‰¹æ®Šå­—ç¬¦
                      Object.entries(params).forEach(([key, value]) => {
                          if (value !== null && value !== undefined && value !== '') {
                              if (Array.isArray(value)) {
                                  // å¯¹äºæ•°ç»„å‚æ•°ï¼Œæ·»åŠ å¤šä¸ªåŒåå‚æ•°
                                  value.forEach(v => {
                                      if (v !== null && v !== undefined && v !== '') {
                                          url.searchParams.append(key, v);
                                      }
                                  });
                              } else {
                                  url.searchParams.append(key, value);
                              }
                          }
                      });
                     
                     // æ›´æ–°URLè¾“å…¥æ¡†ï¼ˆä½†ä¸è§¦å‘parseUrlParamsï¼‰
                     urlInput.removeEventListener('input', parseUrlParams);
                     urlInput.value = url.toString();
                     setTimeout(() => {
                         urlInput.addEventListener('input', parseUrlParams);
                     }, 100);
                 }
             } catch (error) {
                 // å‚æ•°æ ¼å¼é”™è¯¯æ—¶ä¸å¤„ç†
                 console.log('å‚æ•°æ ¼å¼é”™è¯¯:', error.message);
             }
         }
         
         // é˜²æŠ–å‡½æ•°ï¼Œé¿å…é¢‘ç¹åŒæ­¥
         let syncTimeout;
         function debounceSync() {
             clearTimeout(syncTimeout);
             syncTimeout = setTimeout(() => {
                 syncParamsToUrl();
             }, 500);
         }
         
         // åˆå§‹åŒ–URLå‚æ•°è§£æ
         function initUrlParamSync() {
             const urlInput = document.getElementById('apiUrl');
             const paramsTextarea = document.getElementById('apiParams');
             
             // ä¸ºURLè¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
             urlInput.addEventListener('input', parseUrlParams);
             urlInput.addEventListener('paste', () => {
                 setTimeout(parseUrlParams, 100);
             });
             
             // ä¸ºå‚æ•°æ–‡æœ¬æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
             paramsTextarea.addEventListener('input', debounceSync);
             paramsTextarea.addEventListener('paste', () => {
                 setTimeout(debounceSync, 100);
             });
         }
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µçš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // æµ‹è¯•APIæ¥å£
        async function testApi() {
            try {
                showLoading(true);
                
                const config = {
                    url: document.getElementById('apiUrl').value,
                    method: document.getElementById('apiMethod').value,
                    headers: JSON.parse(document.getElementById('apiHeaders').value || '{}'),
                    params: JSON.parse(document.getElementById('apiParams').value || '{}'),
                    data: JSON.parse(document.getElementById('apiData').value || '{}')
                };
                
                currentConfig.api_config = config;
                
                const response = await fetch('/api/test-api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('APIæµ‹è¯•æˆåŠŸï¼');
                    document.getElementById('apiResult').innerHTML = `
                        <h3>APIå“åº”ç»“æœ</h3>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(result.data, null, 2)}</pre>
                    `;
                } else {
                    showMessage(`APIæµ‹è¯•å¤±è´¥: ${result.error}`, 'error');
                }
                
            } catch (error) {
                showMessage(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // æ·»åŠ åˆ—æ˜ å°„
        function addColumnMapping() {
            const container = document.getElementById('columnMappings');
            const div = document.createElement('div');
            div.className = 'column-item';
            div.innerHTML = `
                <input type="text" placeholder="APIå­—æ®µå" class="api-field">
                <span>â†’</span>
                <input type="text" placeholder="Excelåˆ—å" class="excel-field">
                <button type="button" class="btn btn-danger" onclick="removeColumnMapping(this)">åˆ é™¤</button>
            `;
            container.appendChild(div);
        }
        
        // åˆ é™¤åˆ—æ˜ å°„
        function removeColumnMapping(button) {
            button.parentElement.remove();
        }
        
        // åˆ‡æ¢åˆ†é¡µé…ç½®æ˜¾ç¤º
        function togglePaginationConfig() {
            const exportMode = document.getElementById('exportMode').value;
            const paginationConfig = document.getElementById('paginationConfig');
            
            if (exportMode === 'all') {
                paginationConfig.style.display = 'block';
            } else {
                paginationConfig.style.display = 'none';
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            try {
                showLoading(true);
                
                // æ”¶é›†APIé…ç½®
                const apiConfig = {
                    url: document.getElementById('apiUrl').value,
                    method: document.getElementById('apiMethod').value,
                    headers: document.getElementById('apiHeaders').value,
                    params: document.getElementById('apiParams').value,
                    data: document.getElementById('apiData').value
                };
                
                // æ”¶é›†Excelé…ç½®
                const columnMappings = {};
                document.querySelectorAll('.column-item').forEach(item => {
                    const apiField = item.querySelector('.api-field').value;
                    const excelField = item.querySelector('.excel-field').value;
                    if (apiField && excelField) {
                        columnMappings[apiField] = excelField;
                    }
                });
                
                const excelConfig = {
                    data_path: document.getElementById('dataPath').value,
                    column_mapping: columnMappings,
                    selected_columns: document.getElementById('selectedColumns').value.split(',').map(s => s.trim()).filter(s => s)
                };
                
                // æ”¶é›†åˆ†é¡µé…ç½®
                const exportMode = document.getElementById('exportMode').value;
                const paginationConfig = {};
                
                if (exportMode === 'all') {
                    paginationConfig.cursor_param = document.getElementById('cursorParam').value || 'cursor';
                    paginationConfig.page_size_param = document.getElementById('pageSizeParam').value || 'per_page';
                    paginationConfig.page_param = document.getElementById('pageParam').value || 'page';
                    paginationConfig.max_pages = parseInt(document.getElementById('maxPages').value) || 100;
                    paginationConfig.next_cursor_path = document.getElementById('nextCursorPath').value || 'links.next.cursor';
                }
                
                const exportConfig = {
                    api_config: apiConfig,
                    excel_config: excelConfig,
                    export_mode: exportMode,
                    pagination_config: paginationConfig
                };
                
                console.log('å¯¼å‡ºé…ç½®:', exportConfig);
                
                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(exportConfig)
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `export_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showMessage('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼');
                } else {
                    const error = await response.json();
                    showMessage(`å¯¼å‡ºå¤±è´¥: ${error.error}`, 'error');
                }
                
            } catch (error) {
                showMessage(`å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ä¿å­˜æ¨¡æ¿
        async function saveTemplate() {
            const templateName = document.getElementById('templateName').value;
            if (!templateName) {
                showMessage('è¯·è¾“å…¥æ¨¡æ¿åç§°', 'error');
                return;
            }
            
            try {
                // æ”¶é›†å½“å‰é…ç½®
                const config = {
                    api_config: {
                        url: document.getElementById('apiUrl').value,
                        method: document.getElementById('apiMethod').value,
                        headers: document.getElementById('apiHeaders').value,
                        params: document.getElementById('apiParams').value,
                        data: document.getElementById('apiData').value
                    },
                    excel_config: {
                        data_path: document.getElementById('dataPath').value,
                        selected_columns: document.getElementById('selectedColumns').value
                    }
                };
                
                // æ”¶é›†åˆ—æ˜ å°„
                const columnMappings = {};
                document.querySelectorAll('.column-item').forEach(item => {
                    const apiField = item.querySelector('.api-field').value;
                    const excelField = item.querySelector('.excel-field').value;
                    if (apiField && excelField) {
                        columnMappings[apiField] = excelField;
                    }
                });
                config.excel_config.column_mappings = columnMappings;
                
                const response = await fetch(`/api/templates/${templateName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showMessage('æ¨¡æ¿ä¿å­˜æˆåŠŸï¼');
                    loadTemplates();
                    document.getElementById('templateName').value = '';
                } else {
                    showMessage(`ä¿å­˜å¤±è´¥: ${result.error}`, 'error');
                }
                
            } catch (error) {
                showMessage(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // åŠ è½½æ¨¡æ¿åˆ—è¡¨
        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates');
                const templates = await response.json();
                
                const container = document.getElementById('templateItems');
                container.innerHTML = '';
                
                if (templates.length === 0) {
                    container.innerHTML = '<p>æš‚æ— ä¿å­˜çš„æ¨¡æ¿</p>';
                    return;
                }
                
                templates.forEach(templateName => {
                    const div = document.createElement('div');
                    div.className = 'template-item';
                    div.innerHTML = `
                        <span>${templateName}</span>
                        <div>
                            <button class="btn btn-primary" onclick="loadTemplate('${templateName}')">åŠ è½½</button>
                            <button class="btn btn-success" onclick="updateTemplate('${templateName}')">æ›´æ–°</button>
                            <button class="btn btn-danger" onclick="deleteTemplate('${templateName}')">åˆ é™¤</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
                
            } catch (error) {
                showMessage(`åŠ è½½æ¨¡æ¿å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // åŠ è½½æ¨¡æ¿
        async function loadTemplate(templateName) {
            try {
                const response = await fetch(`/api/templates/${templateName}`);
                const template = await response.json();
                
                if (response.ok) {
                    // åŠ è½½APIé…ç½®
                    const apiConfig = template.api_config || {};
                    document.getElementById('apiUrl').value = apiConfig.url || '';
                    document.getElementById('apiMethod').value = apiConfig.method || 'GET';
                    document.getElementById('apiHeaders').value = apiConfig.headers || '';
                    document.getElementById('apiParams').value = apiConfig.params || '';
                    document.getElementById('apiData').value = apiConfig.data || '';
                    
                    // åŠ è½½Excelé…ç½®
                    const excelConfig = template.excel_config || {};
                    document.getElementById('dataPath').value = excelConfig.data_path || '';
                    document.getElementById('selectedColumns').value = excelConfig.selected_columns || '';
                    
                    // åŠ è½½åˆ—æ˜ å°„
                    const container = document.getElementById('columnMappings');
                    container.innerHTML = '';
                    
                    const columnMappings = excelConfig.column_mappings || {};
                    if (Object.keys(columnMappings).length > 0) {
                        Object.entries(columnMappings).forEach(([apiField, excelField]) => {
                            const div = document.createElement('div');
                            div.className = 'column-item';
                            div.innerHTML = `
                                <input type="text" placeholder="APIå­—æ®µå" class="api-field" value="${apiField}">
                                <span>â†’</span>
                                <input type="text" placeholder="Excelåˆ—å" class="excel-field" value="${excelField}">
                                <button type="button" class="btn btn-danger" onclick="removeColumnMapping(this)">åˆ é™¤</button>
                            `;
                            container.appendChild(div);
                        });
                    } else {
                        addColumnMapping();
                    }
                    
                    showMessage(`æ¨¡æ¿ "${templateName}" åŠ è½½æˆåŠŸï¼`);
                } else {
                    showMessage(`åŠ è½½æ¨¡æ¿å¤±è´¥: ${template.error}`, 'error');
                }
                
            } catch (error) {
                showMessage(`åŠ è½½æ¨¡æ¿å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // åˆ é™¤æ¨¡æ¿
        async function deleteTemplate(templateName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ "${templateName}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/templates/${templateName}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (response.ok) {
                    showMessage('æ¨¡æ¿åˆ é™¤æˆåŠŸï¼');
                    loadTemplates();
                } else {
                    showMessage(`åˆ é™¤å¤±è´¥: ${result.error}`, 'error');
                }
                
            } catch (error) {
                showMessage(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ›´æ–°æ¨¡æ¿
        async function updateTemplate(templateName) {
            if (!confirm(`ç¡®å®šè¦æ›´æ–°æ¨¡æ¿ "${templateName}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                // æ”¶é›†å½“å‰é…ç½®
                const config = {
                    api_config: {
                        url: document.getElementById('apiUrl').value,
                        method: document.getElementById('apiMethod').value,
                        headers: document.getElementById('apiHeaders').value,
                        params: document.getElementById('apiParams').value,
                        data: document.getElementById('apiData').value
                    },
                    excel_config: {
                        data_path: document.getElementById('dataPath').value,
                        selected_columns: document.getElementById('selectedColumns').value
                    }
                };
                
                // æ”¶é›†åˆ—æ˜ å°„
                const columnMappings = {};
                document.querySelectorAll('.column-item').forEach(item => {
                    const apiField = item.querySelector('.api-field').value;
                    const excelField = item.querySelector('.excel-field').value;
                    if (apiField && excelField) {
                        columnMappings[apiField] = excelField;
                    }
                });
                config.excel_config.column_mappings = columnMappings;
                
                const response = await fetch(`/api/templates/${templateName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showMessage(`æ¨¡æ¿ "${templateName}" æ›´æ–°æˆåŠŸï¼`);
                    loadTemplates();
                } else {
                    showMessage(`æ›´æ–°å¤±è´¥: ${result.error}`, 'error');
                }
                
            } catch (error) {
                showMessage(`æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰è¡¨å•
        function clearAllForms() {
            document.getElementById('apiForm').reset();
            document.getElementById('excelForm').reset();
            document.getElementById('templateName').value = '';
            document.getElementById('apiResult').innerHTML = '';
            document.getElementById('columnMappings').innerHTML = '';
            addColumnMapping();
        }
        
        // æ¸…ç©ºè¡¨å•
        function clearApiForm() {
            document.getElementById('apiForm').reset();
            document.getElementById('apiResult').innerHTML = '';
        }
        
        function clearExcelForm() {
            document.getElementById('excelForm').reset();
            document.getElementById('columnMappings').innerHTML = '';
            addColumnMapping();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addColumnMapping();
            loadTemplates();
            initUrlParamSync();
        });
    </script>
</body>
</html>